- name: "[GCLOUD]      | Ensure GCloud repo present"
  when:
    - ansible_pkg_mgr == 'dnf'
  copy: src=dnf/repos/gcloud.repo
    dest=/etc/yum.repos.d/
    owner=root group=root mode=0644

- name: "[GCLOUD]      | Install the Google cloud CLI tool"
  when:
    - ansible_pkg_mgr == 'dnf'
  dnf: name={{item}}
  with_items:
    - google-cloud-sdk
    - google-cloud-sdk-gke-gcloud-auth-plugin

- name: "[GCLOUD]      | Install the Google cloud CLI perquisites"
  when:
    - ansible_pkg_mgr == 'apt'
  apt: name={{item}}
  with_items:
    - apt-transport-https
    - ca-certificates
    - gnupg
    - curl

# TODO run curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
# - name: "[GCLOUD]      | Add Google Cloud apt signing key"
#   ansible.builtin.get_url:
#     url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
#     dest: /usr/share/keyrings/cloud.google.gpg
#     mode: '0644'

- name: "[GCLOUD]      | Add Google Cloud SDK apt repository"
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/google-cloud-sdk.list
    content: |
      deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main
    mode: '0644'

- name: "[GCLOUD]      | install gcloud cli"
  ansible.builtin.apt:
    update_cache: yes
    name:
     - google-cloud-cli
     - google-cloud-cli-gke-gcloud-auth-plugin